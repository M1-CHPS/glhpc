
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../lab6/">
      
      
        <link rel="next" href="../annex/bash_cheatsheet/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.19">
    
    
      
        <title>Lab 7 - AI Project (2) Neural Network Inference - GLHPC - Génie Logiciel pour le Calcul Haute Performance et l'Intelligence Artificielle</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="GLHPC - Génie Logiciel pour le Calcul Haute Performance et l&#39;Intelligence Artificielle" class="md-header__button md-logo" aria-label="GLHPC - Génie Logiciel pour le Calcul Haute Performance et l'Intelligence Artificielle" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GLHPC - Génie Logiciel pour le Calcul Haute Performance et l'Intelligence Artificielle
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 7 - AI Project (2) Neural Network Inference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="red"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="red"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lecture1/" class="md-tabs__link">
          
  
  
  Course

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../annex/bash_cheatsheet/" class="md-tabs__link">
          
  
  
  Annex

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="GLHPC - Génie Logiciel pour le Calcul Haute Performance et l&#39;Intelligence Artificielle" class="md-nav__button md-logo" aria-label="GLHPC - Génie Logiciel pour le Calcul Haute Performance et l'Intelligence Artificielle" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    GLHPC - Génie Logiciel pour le Calcul Haute Performance et l'Intelligence Artificielle
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Course
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Course
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Lectures
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Lectures
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lecture1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L1 - Introduction to Software Engineering for HPC/AI, Development Environment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lecture2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L2 - Performance Aware C Computing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lecture3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L3 - Building, Testing, and Debugging Scientific Software
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lecture4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L4 - Experimental Design, Profiling, and Performance/Energy Optimization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lecture5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L5 - HPC for AI & Environmental Impact of Computation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Labs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Labs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 1 - Prerequisites
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 2 - C Programming and Memory Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 3 - CMake, Unit Tests, and Debugging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 4 - Monte-Carlo sampling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 5 - Experimental Methodology and Scientific Reporting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lab 6 - AI Project (1) SGEMM Kernel Optimization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Lab 7 - AI Project (2) Neural Network Inference
    
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Annex
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Annex
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../annex/bash_cheatsheet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bash cheatsheet
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Linux Environment
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Linux Environment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../annex/install_fedora/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installing fedora
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../annex/oh-my-zsh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installing oh-my-zsh
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="lab-7-projet-ia-part-2-neural-networks-inference-engine">Lab 7: Projet IA - Part 2 - Neural Networks Inference Engine<a class="headerlink" href="#lab-7-projet-ia-part-2-neural-networks-inference-engine" title="Permanent link">&para;</a></h1>
<p>In <a href="../lab6/">lab 6</a>, you implemented and optimized an sgemm library for matrix-matrix multiplication. In this lab, you will use this library to implement a simple neural network inference engine. This lab is inspired by <a href="https://github.com/MichalPitr/inference_engine/">Michal Pitr inference engine project</a> released under the MIT license. Michal Pitr offers a C++ implementation and a series of <a href="https://michalpitr.substack.com/p/build-your-own-inference-engine-from">excellent blog posts</a> explaining the implementation. Feel free to read them, but you must implement the lab in C and produce your own code.</p>
<h2 id="1-design-of-the-inference-engine">1 - Design of the inference engine<a class="headerlink" href="#1-design-of-the-inference-engine" title="Permanent link">&para;</a></h2>
<p>We want to recognize handwritten digits from the MNIST dataset using a neural network. The neural network has been trained using <a href="https://pytorch.org/">PyTorch</a> and the <a href="https://onnx.ai/">ONNX format</a> is used to export the model.</p>
<p><img alt="MNIST dataset examples" src="../image/lab7/MNIST_dataset_example.png" /></p>
<p>The model takes as input a 28x28 grayscale image (784 pixels) and outputs a vector of 10 probabilities, one for each digit (0 to 9). The predicted digit is the one with the highest probability.</p>
<p>The model architecture is described as a computation graph. Each node in the graph represents a layer in the neural network. The edges represent the flow of data between layers.
Our inference engine must support the following four operations:</p>
<ul>
<li><strong>Flatten</strong>: This layer reshapes the input tensor into a 2D matrix. The 28x28 image is flattened into a 784x1 vector.</li>
<li><strong>Add</strong>: This layer performs element-wise addition of two matrices. The operation can be expressed as <code>Y = A + B</code>, where <code>A</code> and <code>B</code> are the input matrices.</li>
<li><strong>Gemm</strong>: This is a fully connected layer. It performs a linear transformation of the input data using weights and biases. The operation can be expressed as <code>Y =  A * B + C</code>, where <code>A</code> is the input matrix, <code>B</code> is the weight matrix, <code>C</code> is the bias vector, and <code>alpha</code> and <code>beta</code> are scaling factors.</li>
<li><strong>Relu</strong>: This layer applies the ReLU (Rectified Linear Unit) activation function, which sets all negative values to zero. The operation can be expressed as <code>Y = max(0, X)</code>, where <code>X</code> is the input matrix.</li>
</ul>
<p>Multiple pre-trained models are available in the <code>models/</code> directory. They differ by their architecture (number and type of layers and number of neurons per layer). You can use the web application <a href="https://netron.app/">Netron</a> to visualize the models.</p>
<p>Your inference engine must be able to execute any of these models. It should be as efficient as possible. You have already optimized the sgemm library in the previous lab.
Now you must implement and optimize the other operations (add, relu, flatten) and the overall scheduling of the model.</p>
<h2 id="2-projet-structure">2 - Projet structure<a class="headerlink" href="#2-projet-structure" title="Permanent link">&para;</a></h2>
<p>Here are the contents of the project starting directory:</p>
<ul>
<li>
<p><code>models/</code>: Directory containing pre-trained ONNX models.</p>
</li>
<li>
<p><code>image-test-set/</code>: Directory containing test images in binary format.</p>
<ul>
<li>
<p><code>image_0.ubyte</code> to <code>image_99.ubyte</code>: 100 test images of handwritten digits in binary format; extracted from the <a href="https://en.wikipedia.org/wiki/MNIST_database">MNIST</a> database. Each file contains 784 bytes (28x28 pixels) representing a grayscale image.</p>
</li>
<li>
<p><code>labels.txt</code>: Text file containing the expected labels for the test images separated by commas. Each value corresponds to the label of the image with the same index (e.g., the first label is the label for image_0.ubyte).</p>
</li>
</ul>
</li>
<li>
<p><code>external/onnx/</code>: Directory containing an ONNX protobuf low-level parser. We use this auto-generated parser to read the ONNX format. You don't need to modify anything in this directory.</p>
</li>
<li>
<p><code>src/</code>: Directory containing the source code.</p>
<ul>
<li>
<p><code>main.c</code>: Minimal main program.</p>
</li>
<li>
<p><code>parse_model.h</code> and <code>parse_model.c</code>: High level code for parsing input images and ONNX models.</p>
</li>
</ul>
</li>
<li>
<p><code>tests/</code>: Directory containing unit tests for <code>parse_model.c</code>.</p>
</li>
<li>
<p><code>CMakeLists.txt</code>: CMake build configuration file.</p>
</li>
</ul>
<h2 id="3-the-parse_model-module">3 - The parse_model module<a class="headerlink" href="#3-the-parse_model-module" title="Permanent link">&para;</a></h2>
<p>The parse_model module provides utilities to load MNIST input images and read ONNX models, exposing a small C API to access model graph info and weight tensors.</p>
<h3 id="data-types">Data types<a class="headerlink" href="#data-types" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><code>struct matrix_t</code>: represents a matrix (weights or data) with fields:</p>
<ul>
<li><code>bool weights</code>, true if the <code>matrix</code> represents weights, false for data. </li>
<li><code>size_t M, N</code>, dimensions of the matrix (<code>MxN</code>).</li>
<li><code>float *data</code>, pointer to the matrix data in row-major order.</li>
</ul>
</li>
<li>
<p><code>struct model_t</code>: opaque model handle (internal representation hidden).</p>
</li>
<li>
<p>The caller is responsible for freeing returned objects using <code>free_matrix()</code> and <code>free_model()</code>.</p>
</li>
</ul>
<h3 id="core-functions">Core functions<a class="headerlink" href="#core-functions" title="Permanent link">&para;</a></h3>
<ul>
<li><code>struct matrix_t* read_mnist_input(char *filename)</code>: load a 28×28 MNIST image as a 784×1 matrix.</li>
<li><code>void free_matrix(struct matrix_t *m)</code>: free <code>a matrix_t</code>.</li>
<li><code>struct model_t* read_onnx_model(const char *filename)</code>: parse an ONNX file and return a model handle.</li>
<li><code>void free_model(struct model_t *model)</code>: free the model handle.</li>
<li><code>struct matrix_t* get_weight_matrix(struct model_t *model, char *name)</code>: retrieve an initializer (weight/bias) by name.</li>
</ul>
<h3 id="graph-inspection-helpers">Graph inspection helpers<a class="headerlink" href="#graph-inspection-helpers" title="Permanent link">&para;</a></h3>
<ul>
<li><code>char * get_graph_input_name(struct model_t *model)</code>: graph input name.</li>
<li><code>char * get_graph_output_name(struct model_t *model)</code>: graph output name.</li>
<li><code>size_t get_number_nodes(struct model_t *model)</code>: number of nodes in the graph.</li>
<li><code>char * get_node_name(struct model_t *model, size_t node_pos)</code>: node name.</li>
<li><code>char * get_op_type(struct model_t *model, size_t node_pos)</code>: node operator type (e.g. "Gemm", "Relu", "Add", or "Flatten").</li>
<li><code>char * get_output_name(struct model_t *model, size_t node_pos)</code>: node output name.</li>
<li><code>size_t get_number_inputs(struct model_t *model, size_t node_pos)</code>: number of inputs for a node.</li>
<li><code>char * get_input_name(struct model_t *model, size_t node_pos, size_t input_pos)</code>: name of a node input.</li>
</ul>
<h3 id="example-click-on-the-image-to-see-it-in-full-size">Example <em>(Click on the image to see it in full size)</em><a class="headerlink" href="#example-click-on-the-image-to-see-it-in-full-size" title="Permanent link">&para;</a></h3>
<p><a href="../image/lab7/mnist.svg"><img alt="Model graph for mnist.onnx" src="../image/lab7/mnist.svg" /></a></p>
<p>For the model <code>models/mnist.onnx</code>,</p>
<ul>
<li>
<p><code>get_number_nodes(model)</code> returns <code>15</code>.</p>
</li>
<li>
<p>The first node is a Flatten layer named "/Flatten", </p>
</li>
<li>
<p><code>get_node_name(model, 0)</code> returns <code>"/Flatten"</code> and <code>get_op_type(model, 0)</code> returns <code>"Flatten"</code>. </p>
</li>
<li>
<p>Flatten has one input : <code>get_number_inputs(model, 0)</code> returns <code>1</code>.</p>
<ul>
<li>The input comes from the graph input named <code>"onnx::Flatten_0"</code>: <code>get_input_name(model, 0, 0)</code> returns <code>"onnx::Flatten_0"</code>.</li>
</ul>
</li>
<li>
<p>Flatten has one output. In our models all layers have a single output, but it can be consumed by multiple nodes (as is the case for the first /Relu layer in our example).</p>
<ul>
<li>The output of the Flatten layer is named <code>"/Flatten_output_0"</code>: <code>get_output_name(model, 0)</code> returns <code>"/Flatten_output_0"</code>.</li>
</ul>
</li>
<li>
<p>The second node is a fully connected layer named "/l1/Gemm",</p>
<ul>
<li>
<p><code>get_node_name(model, 1)</code> returns <code>"/l1/Gemm"</code> and <code>get_op_type(model, 1)</code> returns <code>"Gemm"</code>.</p>
</li>
<li>
<p>Gemm has three inputs (the input data, the weights, and the biases): <code>get_number_inputs(model, 1)</code> returns <code>3</code>.</p>
<ul>
<li>
<p>The first input comes from the output of the previous Flatten layer: <code>get_input_name(model, 1, 0)</code> returns <code>"/Flatten_output_0"</code>.</p>
</li>
<li>
<p>The second input is the weight matrix named <code>"l1.weight"</code>: <code>get_input_name(model, 1, 1)</code> returns <code>"l1.weight"</code>.</p>
</li>
<li>
<p>The third input is the bias vector named <code>"l1.bias"</code>: <code>get_input_name(model, 1, 2)</code> returns <code>"l1.bias"</code>.</p>
</li>
</ul>
</li>
<li>
<p>The output of the Gemm layer is named <code>"/l1/Gemm_output_0"</code>: <code>get_output_name(model, 1)</code> returns <code>"/l1/Gemm_output_0"</code>.</p>
</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the provided ONNX models weight matrices are stored in column-major order. 
The <code>get_weight_matrix()</code> function takes care of this for you by transposing the data and returning a <code>matrix_t</code> structure in row-major order.</p>
<p>We can avoid this transposition by changing the sgemm library to support column-major order in the second matrix, but this is not required for this project.</p>
</div>
<h2 id="4-implementation-tasks">4 - Implementation tasks<a class="headerlink" href="#4-implementation-tasks" title="Permanent link">&para;</a></h2>
<h3 id="1-implementing-the-four-layer-operations">1. Implementing the four layer operations<a class="headerlink" href="#1-implementing-the-four-layer-operations" title="Permanent link">&para;</a></h3>
<p>Implement functions to execute the four operations (Flatten, Add, Gemm, Relu) using the <code>matrix_t</code> data structure. You should create a new source file (e.g., <code>inference.c</code>).</p>
<p>Some hints:</p>
<ul>
<li>
<p>Flatten is straightforward: it just reshapes the input matrix. You can create a new <code>matrix_t</code> with the appropriate dimensions and copy the data.</p>
</li>
<li>
<p>Add and Relu can be implemented using simple loops. You can optimize them using techniques like loop unrolling or SIMD intrinsics.</p>
</li>
<li>
<p>For Gemm, you can use the optimized sgemm library you implemented in the previous lab.</p>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Make sure to add relevant unit tests for each operation in the <code>tests/</code> directory.</p>
</div>
<h3 id="2-implementing-a-scheduler-for-the-model-graph">2. Implementing a scheduler for the model graph<a class="headerlink" href="#2-implementing-a-scheduler-for-the-model-graph" title="Permanent link">&para;</a></h3>
<p>Implement a function to execute the model graph. The function should take a <code>model_t</code> and an input <code>matrix_t</code>, and return the output <code>matrix_t</code>.</p>
<p>You can use the graph inspection helpers to traverse the graph and execute each node. You will need to maintain a mapping from node output names to <code>matrix_t</code> objects to keep track of intermediate results.</p>
<p>The order of execution must respect the dependencies between nodes. Thus you need to ensure that the execution follows a topological order.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Include tests for the scheduler in the <code>tests/</code> directory.</p>
</div>
<h3 id="3-testing-and-benchmarking">3. Testing and benchmarking<a class="headerlink" href="#3-testing-and-benchmarking" title="Permanent link">&para;</a></h3>
<p>Use the provided test images and labels to validate your implementation. Include tests in the <code>tests/</code> directory to verify the correctness of each operation and the overall model execution.</p>
<p>Measure the accuracy of each model by comparing the predicted labels with the expected labels from <code>labels.txt</code>. Report the accuracy for each model.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To compute a simple accuracy metric, you can count the number of correct predictions and divide by the total number of images.
More advanced metrics (precision, recall, F1-score) are not required for this lab.</p>
</div>
<p>You can use the <code>main.c</code> file to implement a simple command-line interface to load a model, load an input image, execute the model, and print the predicted label.</p>
<h3 id="4-optimization-and-performance-analysis">4. Optimization and performance analysis<a class="headerlink" href="#4-optimization-and-performance-analysis" title="Permanent link">&para;</a></h3>
<p>Optimize the implementation for performance and energy efficiency. You can
experiment with parallel execution of the graph nodes, pipelining, and other
optimization techniques.
o
Benchmark the execution time and energy consumption of your implementation. Include your benchmarking scripts in a <code>performance/</code> directory.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Keep the performance measurements for each version of your code so you can compare them in the final report.
Do not forget to track versions with git commits.</p>
<p>The project is open-ended and there are many possible approaches to implement and optimize the inference engine. The goal is to learn about neural networks, ONNX format, and performance optimization techniques. Feel free to explore and experiment with different ideas. If you have access to a GPU, you can also try to implement parts of the inference engine using CUDA or OpenCL.</p>
</div>
<h2 id="5-submission">5 - Submission<a class="headerlink" href="#5-submission" title="Permanent link">&para;</a></h2>
<p>Submit your implementation in GitHub Classroom. Make sure to include a <code>README.md</code> file with instructions on how to build and run your code, as well as any dependencies required.</p>
<p>Include a report (in PDF format, <code>Report.pdf</code>) describing your implementation, the optimizations you applied, and the performance results you obtained. Be sure to include the graphs and analysis of the SGEMM optimizations from the previous lab as well. The report should be around 3000 words (about 5 pages in 11pt without figures, tables and code excerpts).</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../lab6/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Lab 6 - AI Project (1) SGEMM Kernel Optimization">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Lab 6 - AI Project (1) SGEMM Kernel Optimization
              </div>
            </div>
          </a>
        
        
          
          <a href="../annex/bash_cheatsheet/" class="md-footer__link md-footer__link--next" aria-label="Next: Bash cheatsheet">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Bash cheatsheet
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      CC BY-NC 4.0; 2025 - Pablo de Oliveira Castro, Mathys E. Jam
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.path", "navigation.instant", "navigation.instant.progress", "navigation.expand", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.footer", "header.autohide", "toc.integrate", "content.code.annotate", "content.tabs.link", "content.code.copy"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>